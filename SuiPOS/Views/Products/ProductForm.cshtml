@model SuiPOS.ViewModels.ProductInputVM

@{
    ViewData["Title"] = "Tạo sản phẩm mới";
}

<div class="min-h-screen bg-gray-50 py-6 px-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold text-gray-900">Tạo sản phẩm</h1>
            <a href="@Url.Action("Index", "Products")" class="px-4 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>
                Quay lại
            </a>
        </div>

        <form asp-action="Create" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"></div>

            <!-- Thông tin chung -->
            <div class="flex justify-between gap-5">
                <!-- Hình ảnh sản phẩm -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-2 flex items-center gap-2">
                        Hình ảnh sản phẩm
                        <i class="fas fa-info-circle text-blue-500 text-sm cursor-help" title="Tải lên hình ảnh hoặc nhập URL"></i>
                    </h2>

                    <div class="mt-6">
                        <!-- Upload Area -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
                            <input asp-for="ImageFile" type="file" id="imageFile" accept="image/*" class="hidden" onchange="previewImage(event)" />

                            <div id="uploadArea">
                                <div class="mb-4">
                                    <i class="fas fa-image text-6xl text-gray-300"></i>
                                </div>
                                <button type="button" onclick="document.getElementById('imageFile').click()"
                                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Thêm ảnh
                                </button>
                                <p class="text-sm text-gray-500 mt-4">
                                    <a href="#" onclick="toggleUrlInput(); return false;" class="text-blue-600 hover:underline">Thêm từ URL</a>
                                    <span class="text-gray-400 mx-2">(Hình ảnh/Video)</span>
                                </p>
                            </div>

                            <div id="urlInputArea" class="hidden mt-4">
                                <input type="text" id="imageUrl"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Nhập URL hình ảnh" />
                                <button type="button" onclick="loadImageFromUrl()"
                                        class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Tải ảnh
                                </button>
                            </div>

                            <div id="imagePreview" class="hidden mt-4 object-fit">
                                <img id="previewImg" src="" alt="Preview" class="max-h-64 max-l-64 rounded-lg" />
                                <button type="button" onclick="removeImage()"
                                        class="mt-3 text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash mr-2"></i>Xóa ảnh
                                </button>
                            </div>
                        </div>
                        <span asp-validation-for="ImageFile" class="text-red-500 text-sm mt-1 block"></span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm p-6 mb-6 w-full">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Thông tin chung</h2>

                    <div class="space-y-6">
                        <!-- Tên sản phẩm -->
                        <div>
                            <label asp-for="Name" class="block text-sm font-medium text-gray-700 mb-2">Tên sản phẩm</label>
                            <input asp-for="Name"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Nhập tên sản phẩm" />
                            <span asp-validation-for="Name" class="text-red-500 text-sm mt-1 block"></span>
                        </div>

                        <div class="grid grid-cols-2 gap-6">
                            <!-- Loại sản phẩm -->
                            <div>
                                <label asp-for="CategoryId" class="block text-sm font-medium text-gray-700 mb-2">Loại</label>
                                <select asp-for="CategoryId" asp-items="ViewBag.Categories"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Chọn loại sản phẩm</option>
                                </select>
                                <span asp-validation-for="CategoryId" class="text-red-500 text-sm mt-1 block"></span>
                            </div>

                            <!-- Thương hiệu (optional - có thể để trống) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                                    Giá bán
                                    <i class="fas fa-info-circle text-blue-500 text-sm cursor-help" title="Giá bán cho khách hàng"></i>
                                </label>
                                <div class="relative">
                                    <input type="number" id="basePrice" min="0" step="1000"
                                           class="w-full px-4 py-3 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="0" />
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">₫</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Biến thể -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Biến thể</h2>
                
                <div id="attributesContainer">
                    <!-- Thuộc tính sẽ được thêm động khi click nút -->
                </div>

                <button type="button" onclick="addAttributeRow()" 
                        class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Thêm thuộc tính khác
                </button>

                <!-- Chọn hàng loạt -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-gray-700">Chọn hàng loạt:</span>
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="selectAllVariants()" class="text-sm text-blue-600 hover:underline">Chọn tất cả</button>
                            <button type="button" onclick="deselectAllVariants()" class="text-sm text-blue-600 hover:underline">Bỏ chọn</button>
                        </div>
                    </div>
                    
                    <div id="selectedVariantsDisplay" class="flex flex-wrap gap-2 mb-4">
                        <!-- Display selected variants as badges -->
                    </div>

                    <a href="#" onclick="showAddVariantModal(); return false;" class="text-blue-600 hover:underline text-sm">
                        Thêm biến thể mới
                    </a>
                </div>

                <!-- Danh sách biến thể -->
                <div class="mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-sm font-medium text-gray-700" id="variantCount">0 Biến thể</span>
                        <button type="button" class="text-sm text-gray-600 hover:text-gray-800 flex items-center gap-2">
                            <i class="fas fa-edit"></i>
                            Chỉnh sửa biến thể
                        </button>
                    </div>

                    <div id="variantsContainer" class="space-y-3">
                        <p class="text-gray-500 text-sm">Chọn thuộc tính để tạo biến thể</p>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex justify-end gap-3">
                <a href="@Url.Action("Index", "Products")" 
                   class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Hủy
                </a>
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-save"></i>
                    Lưu sản phẩm
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let attributes = [];
        let selectedAttributeValues = {};
        let variants = [];
        let attributeRowIndex = 0;

        $(document).ready(function() {
            loadAttributes();
        });

        function loadAttributes() {
            $.get('@Url.Action("GetAttributes", "Products")', function(data) {
                attributes = data;
            });
        }

        // Thêm row mới cho thuộc tính
        function addAttributeRow() {
            const rowId = `attr-row-${attributeRowIndex}`;
            
            // Tạo dropdown options từ danh sách attributes
            const optionsHtml = attributes.map(attr => 
                `<option value="${attr.id}">${attr.name}</option>`
            ).join('');

            const html = `
                <div class="mb-6 pb-6 border-b border-gray-200" id="${rowId}">
                    <div class="grid grid-cols-2 gap-6">
                        <!-- Cột Thuộc tính -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Thuộc tính</label>
                            <div class="flex items-center gap-3">
                                <select id="attr-select-${attributeRowIndex}" 
                                        onchange="onAttributeSelected('${rowId}', this.value, ${attributeRowIndex})"
                                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">Chọn thuộc tính</option>
                                    ${optionsHtml}
                                </select>
                                <button type="button" onclick="removeAttributeRow('${rowId}')" 
                                        class="text-red-600 hover:text-red-800 p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Cột Giá trị -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Giá trị</label>
                            <div id="values-container-${attributeRowIndex}">
                                <input type="text" placeholder="Chọn thuộc tính trước" 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" 
                                       disabled />
                            </div>
                        </div>
                    </div>

                    <!-- Selected values display -->
                    <div id="selected-values-${attributeRowIndex}" class="mt-4 flex flex-wrap gap-2">
                        <!-- Selected values will appear here as badges -->
                    </div>
                </div>
            `;

            $('#attributesContainer').append(html);
            attributeRowIndex++;
        }

        // Khi chọn thuộc tính từ dropdown
        function onAttributeSelected(rowId, attrId, rowIndex) {
            if (!attrId) {
                $(`#values-container-${rowIndex}`).html(`
                    <input type="text" placeholder="Chọn thuộc tính trước" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" 
                           disabled />
                `);
                $(`#selected-values-${rowIndex}`).html('');
                return;
            }

            const attr = attributes.find(a => a.id === attrId);
            if (!attr) return;

            // Hiện input để thêm giá trị mới + nút Xong
            let html = `
                <div class="flex gap-2">
                    <input type="text" id="new-value-input-${rowIndex}" 
                           placeholder="Thêm giá trị mới" 
                           class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button type="button" onclick="addNewValue('${attrId}', ${rowIndex})" 
                            class="px-6 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50">
                        Xong
                    </button>
                </div>
            `;

            $(`#values-container-${rowIndex}`).html(html);

            // Hiện các giá trị có sẵn dưới dạng buttons
            if (attr.values && attr.values.length > 0) {
                const valuesHtml = attr.values.map(val => `
                    <button type="button" 
                            id="value-btn-${rowIndex}-${val.id}"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition"
                            onclick="toggleAttributeValue('${attrId}', '${val.id}', '${val.value}', ${rowIndex})">
                        ${val.value}
                    </button>
                `).join('');

                $(`#selected-values-${rowIndex}`).html(`
                    <div class="w-full">
                        <div class="text-sm text-gray-600 mb-2">Hoặc chọn giá trị có sẵn:</div>
                        <div class="flex flex-wrap gap-2">
                            ${valuesHtml}
                        </div>
                    </div>
                `);
            }
        }

        // Thêm giá trị mới
        function addNewValue(attrId, rowIndex) {
            const inputId = `new-value-input-${rowIndex}`;
            const value = $(`#${inputId}`).val().trim();
            
            if (!value) {
                alert('Vui lòng nhập giá trị');
                return;
            }

            // Tạo ID tạm cho giá trị mới
            const newValueId = `new-${Date.now()}`;
            
            // Thêm vào selectedAttributeValues
            if (!selectedAttributeValues[attrId]) {
                selectedAttributeValues[attrId] = [];
            }
            selectedAttributeValues[attrId].push(newValueId);

            // Cập nhật attributes để lưu giá trị mới
            const attr = attributes.find(a => a.id === attrId);
            if (attr) {
                attr.values.push({ id: newValueId, value: value });
            }

            // Thêm badge cho giá trị đã chọn
            const badge = `
                <span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg">
                    ${value}
                    <button type="button" onclick="removeSelectedValue('${attrId}', '${newValueId}', ${rowIndex})" 
                            class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times"></i>
                    </button>
                </span>
            `;

            $(`#selected-values-${rowIndex}`).prepend(badge);
            $(`#${inputId}`).val('');

            generateVariants();
        }

        // Toggle chọn giá trị có sẵn
        function toggleAttributeValue(attrId, valueId, valueName, rowIndex) {
            const btnId = `value-btn-${rowIndex}-${valueId}`;
            const btn = $(`#${btnId}`);
            
            btn.toggleClass('bg-blue-600 text-white border-blue-600');
            
            if (!selectedAttributeValues[attrId]) {
                selectedAttributeValues[attrId] = [];
            }

            const index = selectedAttributeValues[attrId].indexOf(valueId);
            if (index === -1) {
                selectedAttributeValues[attrId].push(valueId);
            } else {
                selectedAttributeValues[attrId].splice(index, 1);
            }

            generateVariants();
        }

        // Xóa giá trị đã chọn
        function removeSelectedValue(attrId, valueId, rowIndex) {
            if (selectedAttributeValues[attrId]) {
                const index = selectedAttributeValues[attrId].indexOf(valueId);
                if (index > -1) {
                    selectedAttributeValues[attrId].splice(index, 1);
                }
            }

            // Remove button highlight if exists
            $(`#value-btn-${rowIndex}-${valueId}`).removeClass('bg-blue-600 text-white border-blue-600');

            generateVariants();
            
            // Re-render to remove badge
            onAttributeSelected(`attr-row-${rowIndex}`, attrId, rowIndex);
        }

        // Xóa row thuộc tính
        function removeAttributeRow(rowId) {
            $(`#${rowId}`).remove();
            generateVariants();
        }

        function generateVariants() {
            const attrKeys = Object.keys(selectedAttributeValues).filter(k => selectedAttributeValues[k].length > 0);
            
            if (attrKeys.length === 0) {
                $('#variantsContainer').html('<p class="text-gray-500 text-sm">Chọn thuộc tính để tạo biến thể</p>');
                $('#variantCount').text('0 Biến thể');
                return;
            }

            // Generate all combinations
            const combinations = cartesianProduct(...attrKeys.map(k => selectedAttributeValues[k]));
            variants = combinations.map((combo, index) => {
                const valueIds = Array.isArray(combo) ? combo : [combo];
                const names = valueIds.map(vid => {
                    for (let attr of attributes) {
                        const val = attr.values.find(v => v.id === vid);
                        if (val) return val.value;
                    }
                    return '';
                }).filter(n => n);

                return {
                    combination: names.join(' / '),
                    valueIds: valueIds,
                    sku: '',
                    price: $('#basePrice').val() || 0,
                    stock: 1
                };
            });

            renderVariants();
        }

        function cartesianProduct(...arrays) {
            return arrays.reduce((acc, arr) => 
                acc.flatMap(x => arr.map(y => [...(Array.isArray(x) ? x : [x]), y]))
            , [[]]);
        }

        function renderVariants() {
            $('#variantCount').text(`${variants.length} Biến thể`);

            if (variants.length === 0) {
                $('#variantsContainer').html('<p class="text-gray-500 text-sm">Chưa có biến thể</p>');
                return;
            }

            let html = variants.map((variant, index) => `
                <div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-blue-300">
                    <input type="checkbox" class="w-4 h-4 variant-checkbox" data-index="${index}" />
                    <img src="https://placehold.co/500x400/webp?text=64x64" alt="${variant.combination}"
                         class="w-16 h-16 object-cover rounded" />
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${variant.combination}</div>
                        <div class="text-sm text-gray-500">
                            SKU: <input type="text" name="Variants[${index}].SKU" 
                                       value="${variant.sku}" 
                                       class="inline-block border-0 border-b border-gray-300 px-1 w-32 focus:border-blue-500"
                                       placeholder="Nhập SKU" required />
                        </div>
                        ${variant.valueIds.map((vid, vidx) => 
                            `<input type="hidden" name="Variants[${index}].SelectedAttributeValueIds[${vidx}]" value="${vid}" />`
                        ).join('')}
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-900">
                            <input type="number" name="Variants[${index}].Price" 
                                   value="${variant.price}" 
                                   min="0" step="1000"
                                   class="text-right border-0 border-b border-gray-300 px-1 w-32 focus:border-blue-500" 
                                   required /> ₫
                        </div>
                        <div class="text-sm text-gray-500">
                            <input type="number" name="Variants[${index}].Stock" 
                                   value="${variant.stock}" 
                                   min="0"
                                   class="text-right border-0 border-b border-gray-300 px-1 w-24 focus:border-blue-500" 
                                   required /> khả dụng tại 1 kho hàng
                        </div>
                    </div>
                </div>
            `).join('');

            $('#variantsContainer').html(html);
        }

        function selectAllVariants() {
            $('.variant-checkbox').prop('checked', true);
        }

        function deselectAllVariants() {
            $('.variant-checkbox').prop('checked', false);
        }

        function showAddVariantModal() {
            alert('Chức năng thêm biến thể mới đang được phát triển');
        }

        // Image handling
        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#previewImg').attr('src', e.target.result);
                    $('#uploadArea').addClass('hidden');
                    $('#urlInputArea').addClass('hidden');
                    $('#imagePreview').removeClass('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        function toggleUrlInput() {
            $('#urlInputArea').toggleClass('hidden');
        }

        function loadImageFromUrl() {
            const url = $('#imageUrl').val();
            if (url) {
                $('#previewImg').attr('src', url);
                $('#uploadArea').addClass('hidden');
                $('#urlInputArea').addClass('hidden');
                $('#imagePreview').removeClass('hidden');
            }
        }

        function removeImage() {
            $('#imageFile').val('');
            $('#imageUrl').val('');
            $('#uploadArea').removeClass('hidden');
            $('#imagePreview').addClass('hidden');
        }

        // Update variant prices when base price changes
        $('#basePrice').on('change', function() {
            const price = $(this).val() || 0;
            variants.forEach(v => v.price = price);
            renderVariants();
        });
    </script>
}


