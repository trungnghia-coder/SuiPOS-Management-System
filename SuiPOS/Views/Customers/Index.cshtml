@{
    ViewData["Title"] = "Danh sách khách hàng";
}

@model IEnumerable<SuiPOS.DTOs.Customers.CustomerTableDto>

<div class="min-h-screen bg-gray-50">
    @await Component.InvokeAsync("PageHeader", new { title = "Danh sách khách hàng", showTabs = false })

    <div class="p-6">
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center gap-4 mb-4">
                <div class="flex-1 relative">
                    <input type="text"
                           id="searchCustomer"
                           placeholder="Tìm kiếm theo tên, số điện thoại và email khách hàng"
                           class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <button onclick="openAddCustomer()" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2">
                    <i class="fas fa-plus-circle"></i>
                    Tạo khách hàng
                </button>
            </div>

            <div class="mb-4">
                <span class="text-sm text-gray-600">Có <strong id="customerCount">@Model.Count()</strong> khách hàng</span>
            </div>

            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 font-semibold text-gray-700">Khách hàng</th>
                                <th class="px-4 py-3 font-semibold text-gray-700">Điện thoại</th>
                                <th class="px-4 py-3 font-semibold text-gray-700 text-center">Đơn gần nhất</th>
                                <th class="px-4 py-3 font-semibold text-gray-700 text-center">SL đơn hàng</th>
                                <th class="px-4 py-3 font-semibold text-gray-700 text-right">Nợ phải thu</th>
                                <th class="px-4 py-3 font-semibold text-gray-700 text-right">Tổng chi tiêu</th>
                                <th class="px-4 py-3 font-semibold text-gray-700 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody id="customersTableBody" class="divide-y divide-gray-100">
                            @foreach (var item in Model)
                            {
                                <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="editCustomer('@item.Id', '@item.Customer', '@item.PhoneNumber', '@item.Debt', '@item.SpentTotal')">
                                    <td class="px-4 py-4 text-blue-600 font-medium cursor-pointer">
                                        @item.Customer
                                    </td>
                                    <td class="px-4 py-4 text-gray-600">
                                        @item.PhoneNumber
                                    </td>
                                    <td class="px-4 py-4 text-center text-gray-500">
                                        @(item.LastestOrder?.ToString("dd/MM/yyyy") ?? "--")
                                    </td>
                                    <td class="px-4 py-4 text-center text-gray-600">
                                        @item.CountOrder
                                    </td>
                                    <td class="px-4 py-4 text-right text-red-500">
                                        @item.Debt.ToString("N0") đ
                                    </td>
                                    <td class="px-4 py-4 text-right text-gray-900 font-bold">
                                        @item.SpentTotal.ToString("N0") đ
                                    </td>
                                    <td class="px-4 py-4 text-right" onclick="event.stopPropagation();">
                                        <button onclick="editCustomer('@item.Id', '@item.Customer', '@item.PhoneNumber', '@item.Debt', '@item.SpentTotal')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                            <i class="fas fa-edit text-lg"></i>
                                        </button>
                                        <button onclick="deleteSingleCustomer('@item.Id', '@item.Customer')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                            <i class="fas fa-trash-alt text-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                            }

                        </tbody>
                        <button id="btnDeleteSelected" onclick="deleteSelectedCustomers()" class="hidden text-red-600 hover:text-red-800 transition-colors">
                            <i class="fas fa-trash-alt"></i> Xóa đã chọn
                        </button>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Customer Modal Component -->
@await Component.InvokeAsync("AddCustomerModal")

@section Scripts {
    <script>
        function openAddCustomer() {
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        // Search functionality
        document.getElementById('searchCustomer')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#customersTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });

        //Fill information to Customer POP UP
        function editCustomer(id, name, phone, debt, totalSpent) {
            document.querySelector('#addCustomerModal h2').innerText = "Cập nhật thông tin khách hàng";
            document.getElementById('customerId').value = id;
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone;
            document.getElementById('customerDebt').value = parseFloat(debt) || 0;
            document.getElementById('customerTotalSpent').value = parseFloat(totalSpent) || 0;
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }


        //Remove information to Customer POP UP
        function closeAddCustomer() {
            document.getElementById('addCustomerModal').classList.add('hidden');
            document.getElementById('customerId').value = "";
            document.getElementById('customerName').value = "";
            document.getElementById('customerPhone').value = "";
            document.getElementById('customerDebt').value = "0";
            document.getElementById('customerTotalSpent').value = "0";
            document.querySelector('#addCustomerModal h2').innerText = "Tạo khách hàng mới";
        }


        //Delete function
        async function deleteSingleCustomer(id, name) {
            if (!confirm(`Bạn có chắc chắn muốn xóa khách hàng "${name}" không?`)) return;

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                
                const formData = new FormData();
                formData.append('__RequestVerificationToken', token);

                const response = await fetch(`/Customers/Delete?id=${id}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    location.reload(); 
                } else {
                    alert("Thất bại: " + result.message);
                }
            } catch (error) {
                console.error("Lỗi xóa:", error);
                alert("Đã xảy ra lỗi kết nối với máy chủ!");
            }
        }
    </script>
}
